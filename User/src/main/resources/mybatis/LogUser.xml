<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.whut.tomasyao.log.mapper.LogUserMapper">
    <!--日志查询可以使用缓存,减少服务器压力.但其实也没太大影响,系统运行中不断的调用接口就会产生日志,会不断触发缓存刷新哈哈-->
    <cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>

    <resultMap id="getLogUserRM" type="com.whut.tomasyao.log.vo.LogUserVo">
        <id property="id" column="id"/>
        <result property="createTime" column="create_time"/>
        <result property="params" column="params"/>
        <result property="methodStartTime" column="method_starttime"/>
        <result property="clazz" column="clazz"/>
        <result property="methodTimeTaking" column="method_timetaking"/>
        <result property="method" column="method"/>
        <result property="mavenModule" column="maven_module" typeHandler="org.apache.ibatis.type.EnumOrdinalTypeHandler"/>
        <result property="opType" column="op_type"/>
        <result property="description" column="description"/>
        <result property="result" column="result"/>
        <association property="user" column="user_id" select="com.whut.tomasyao.user.mapper.UserMapper.getUser"/>
    </resultMap>

    <insert id="addLogUser" parameterType="com.whut.tomasyao.log.model.LogUser" useGeneratedKeys="true"
            keyProperty="id">
        insert into log_user(user_id, create_time, params, method_starttime, clazz, method_timetaking, method,
         maven_module, ip, op_type, description, result)
        values(#{user_id}, #{create_time}, #{params}, #{method_starttime}, #{clazz}, #{method_timetaking}, #{method},
         #{maven_module, typeHandler=org.apache.ibatis.type.EnumOrdinalTypeHandler},
         #{ip}, #{op_type}, #{description}, #{result})
    </insert>

    <select id="getLogUserPage" parameterType="hashmap" resultMap="getLogUserRM">
        select * from log_user lu
        <where>
            <if test="user_id != null and user_id > 0">lu.user_id=#{user_id}</if>
            <if test="clazz != null and clazz != ''">and lu.clazz like "%"#{clazz}"%"</if>
            <if test="method != null and method != ''">and lu.method like "%"#{method}"%"</if>
            <if test="maven_module != null and maven_module>=0">and lu.maven_module=#{maven_module}</if>
            <if test="startDate != null and endDate != null">
                and #{startDate} &lt;=lu.create_time and #{endDate} &gt;=lu.create_time</if>
        </where>
        order by ${order} limit #{firstIndex}, #{size}
    </select>

    <select id="findCountLogUserPage" parameterType="hashmap" resultType="int">
        select count(*) from log_user lu
        <where>
            <if test="user_id != null and user_id > 0">lu.user_id=#{user_id}</if>
            <if test="clazz != null and clazz != ''">and lu.clazz like "%"#{clazz}"%"</if>
            <if test="method != null and method != ''">and lu.method like "%"#{method}"%"</if>
            <if test="maven_module != null and maven_module>=0">and lu.maven_module=#{maven_module}</if>
            <if test="startDate != null and endDate != null">
                and #{startDate} &lt;=lu.create_time and #{endDate} &gt;=lu.create_time</if>
        </where>
    </select>

</mapper>
